name: Deploy to GCP VM

on:
  push:
    branches:
      - main
  workflow_dispatch:

jobs:
  deploy:
    name: Build and Deploy to GCP
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v3

      - name: Set up JDK 17
        uses: actions/setup-java@v3
        with:
          java-version: '17'
          distribution: 'temurin'
          cache: maven

      - name: Build Backend with Maven
        run: |
          cd todo-api
          mvn clean package -DskipTests
          echo "âœ… Maven build completed"

      - name: Set up Cloud SDK
        uses: google-github-actions/setup-gcloud@v1
        with:
          service_account_key: ${{ secrets.GCP_SERVICE_ACCOUNT_KEY }}
          project_id: ${{ secrets.GCP_PROJECT_ID }}
          export_default_credentials: true

      - name: Configure SSH
        run: |
          mkdir -p ~/.ssh
          echo "${{ secrets.SSH_PRIVATE_KEY }}" > ~/.ssh/github_actions_rsa
          chmod 600 ~/.ssh/github_actions_rsa
          ssh-keyscan -H ${{ secrets.VM_IP }} >> ~/.ssh/known_hosts

      - name: Deploy to VM
        env:
          VM_USER: ${{ secrets.VM_USERNAME }}
          VM_IP: ${{ secrets.VM_IP }}
        run: |
          ssh -i ~/.ssh/github_actions_rsa -o StrictHostKeyChecking=no ${VM_USER}@${VM_IP} << 'ENDSSH'
            set -e
          
            echo "=== Starting deployment ==="
          
            # Navigate to application directory
            cd ~/my-task-app || exit 1
          
            # Pull latest changes
            echo "ğŸ“¥ Pulling latest code..."
            git fetch origin main
            git reset --hard origin/main
          
            # Stop containers
            echo "â¸ï¸  Stopping containers..."
            docker compose down
          
            # Remove old images
            echo "ğŸ§¹ Cleaning up old images..."
            docker image prune -af
          
            # Rebuild and start
            echo "ğŸ—ï¸  Building and starting containers..."
            docker compose up -d --build
          
            # Wait for services
            echo "â³ Waiting for services to be healthy..."
            sleep 45
          
            # Check status
            echo "ğŸ“Š Container status:"
            docker compose ps
          
            # Check backend health
            echo "ğŸ¥ Checking backend health..."
            for i in {1..10}; do
              if curl -f http://localhost:8080/actuator/health 2>/dev/null; then
                echo "âœ… Backend is healthy!"
                break
              fi
              echo "Waiting for backend... ($i/10)"
              sleep 10
            done
          
            # Show recent logs
            echo "ğŸ“ Recent logs:"
            docker compose logs --tail=50
          
            echo "=== Deployment completed successfully ==="
          ENDSSH

      - name: Verify Deployment
        env:
          VM_IP: ${{ secrets.VM_IP }}
        run: |
          echo "ğŸ” Verifying deployment..."
          sleep 15
          
          echo "Testing Backend Health..."
          if curl -f http://${VM_IP}:8080/actuator/health; then
            echo "âœ… Backend health check passed"
          else
            echo "âš ï¸  Backend health check failed"
          fi
          
          echo "Testing Frontend..."
          if curl -f http://${VM_IP}:3000; then
            echo "âœ… Frontend is accessible"
          else
            echo "âš ï¸  Frontend health check failed"
          fi

      - name: Notify on Success
        if: success()
        run: |
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo "âœ… Deployment Successful!"
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo ""
          echo "ğŸŒ Application URLs:"
          echo "   Frontend:  http://${{ secrets.VM_IP }}:3000"
          echo "   Backend:   http://${{ secrets.VM_IP }}:8080"
          echo "   Health:    http://${{ secrets.VM_IP }}:8080/actuator/health"
          echo ""
          echo "ğŸ“Š Deployment Details:"
          echo "   Branch:    main"
          echo "   Commit:    ${{ github.sha }}"
          echo "   Time:      $(date -u)"
          echo ""

      - name: Notify on Failure
        if: failure()
        run: |
          echo "âŒ Deployment Failed!"
          echo "Check the logs above for details."