name: Deploy to GCP VM

on:
  push:
    branches:
      - main
  workflow_dispatch:

jobs:
  deploy:
    name: Build and Deploy to GCP
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v3

      - name: Set up JDK 17
        uses: actions/setup-java@v3
        with:
          java-version: '17'
          distribution: 'temurin'
          cache: maven

      - name: Build Backend with Maven
        run: |
          cd todo-api
          mvn clean package -DskipTests
          echo "âœ… Maven build completed"

      - name: Set up Cloud SDK
        uses: google-github-actions/setup-gcloud@v1
        with:
          service_account_key: ${{ secrets.GCP_SERVICE_ACCOUNT_KEY }}
          project_id: ${{ secrets.GCP_PROJECT_ID }}
          export_default_credentials: true

      - name: Configure SSH
        run: |
          mkdir -p ~/.ssh
          echo "${{ secrets.SSH_PRIVATE_KEY }}" > ~/.ssh/github_actions_rsa
          chmod 600 ~/.ssh/github_actions_rsa
          ssh-keyscan -H ${{ secrets.VM_IP }} >> ~/.ssh/known_hosts

      - name: Deploy to VM
        env:
          VM_USER: ${{ secrets.VM_USERNAME }}
          VM_IP: ${{ secrets.VM_IP }}
        run: |
          ssh -i ~/.ssh/github_actions_rsa -o StrictHostKeyChecking=no ${VM_USER}@${VM_IP} << 'ENDSSH'
            set -ex
          
            echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
            echo "ğŸš€ Starting Deployment"
            echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          
            # Navigate to application directory
            cd ~/my-task-app || { echo "âŒ Failed to cd to my-task-app"; exit 1; }
          
            # Show current state
            echo ""
            echo "ğŸ“ Current commit on VM:"
            git log -1 --pretty=format:"%h - %s (%cr)" --abbrev-commit
            echo ""
          
            # Ensure we're on main branch
            echo ""
            echo "ğŸ”€ Ensuring we're on main branch..."
            git checkout main
          
            # Force pull latest changes
            echo ""
            echo "ğŸ“¥ Fetching latest code from GitHub..."
            git fetch --all --prune
          
            echo ""
            echo "ğŸ“¥ Resetting to latest main branch..."
            git reset --hard origin/main
            git clean -fd
          
            # Verify update
            echo ""
            echo "âœ… Updated to commit:"
            git log -1 --pretty=format:"%h - %s (%cr)" --abbrev-commit
            echo ""
          
            # Stop containers
            echo ""
            echo "â¸ï¸  Stopping all containers..."
            docker compose down || true
          
            # Remove old images to force rebuild
            echo ""
            echo "ğŸ§¹ Cleaning up old Docker images..."
            docker image prune -af || true
          
            # Rebuild and start containers
            echo ""
            echo "ğŸ—ï¸  Building and starting containers..."
            echo "   (This will take 2-3 minutes...)"
            docker compose up -d --build
          
            # Wait for services to start
            echo ""
            echo "â³ Waiting for services to initialize..."
            sleep 60
          
            # Check container status
            echo ""
            echo "ğŸ“Š Container status:"
            docker compose ps
          
            # Check backend health
            echo ""
            echo "ğŸ¥ Checking backend health..."
            BACKEND_HEALTHY=false
            for i in {1..15}; do
              if curl -f http://localhost:8080/actuator/health 2>/dev/null; then
                echo "âœ… Backend is healthy!"
                BACKEND_HEALTHY=true
                break
              fi
              echo "   Waiting for backend... ($i/15)"
              sleep 10
            done
          
            if [ "$BACKEND_HEALTHY" = false ]; then
              echo "âš ï¸  Warning: Backend health check did not pass"
              echo "   Showing backend logs:"
              docker compose logs --tail=30 backend
            fi
          
            # Show brief logs
            echo ""
            echo "ğŸ“ Recent container logs:"
            docker compose logs --tail=20
          
            echo ""
            echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
            echo "âœ… Deployment completed successfully!"
            echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          ENDSSH

      - name: Verify Deployment
        env:
          VM_IP: ${{ secrets.VM_IP }}
        run: |
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo "ğŸ” Verifying Deployment"
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo ""
          
          # Wait a bit for services to stabilize
          echo "â³ Waiting 15 seconds for services to stabilize..."
          sleep 15
          
          echo ""
          echo "ğŸ¥ Testing Backend Health Endpoint..."
          if curl -f -s http://${VM_IP}:8080/actuator/health | grep -q "UP"; then
            echo "âœ… Backend health check passed"
          else
            echo "âš ï¸  Backend health check failed"
            exit 1
          fi
          
          echo ""
          echo "ğŸŒ Testing Frontend..."
          if curl -f -s -o /dev/null -w "%{http_code}" http://${VM_IP}:3000 | grep -q "200"; then
            echo "âœ… Frontend is accessible"
          else
            echo "âš ï¸  Frontend is not accessible"
            exit 1
          fi

      - name: Deployment Summary
        if: success()
        env:
          VM_IP: ${{ secrets.VM_IP }}
        run: |
          echo ""
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo "âœ… Deployment Successful!"
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo ""
          echo "ğŸŒ Application URLs:"
          echo "   Frontend:    http://${VM_IP}:3000"
          echo "   Backend:     http://${VM_IP}:8080"
          echo "   Health:      http://${VM_IP}:8080/actuator/health"
          echo "   API Docs:    http://${VM_IP}:8080/swagger-ui.html"
          echo ""
          echo "ğŸ“Š Deployment Details:"
          echo "   Repository:  ${{ github.repository }}"
          echo "   Branch:      ${{ github.ref_name }}"
          echo "   Commit:      ${{ github.sha }}"
          echo "   Author:      ${{ github.actor }}"
          echo "   Time:        $(date -u '+%Y-%m-%d %H:%M:%S UTC')"
          echo ""
          echo "ğŸ‰ Your application is live and ready to use!"
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"

      - name: Deployment Failed
        if: failure()
        run: |
          echo ""
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo "âŒ Deployment Failed!"
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo ""
          echo "ğŸ” Please check the logs above for error details."
          echo ""
          echo "ğŸ’¡ Common issues:"
          echo "   â€¢ SSH connection failed"
          echo "   â€¢ Git pull failed"
          echo "   â€¢ Docker build failed"
          echo "   â€¢ Services didn't start properly"
          echo ""
          echo "ğŸ“ Next steps:"
          echo "   1. Check the failed step logs above"
          echo "   2. SSH into your VM and check manually"
          echo "   3. Run: docker compose logs"
          echo ""
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"